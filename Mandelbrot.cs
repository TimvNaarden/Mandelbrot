using Microsoft.Toolkit.Uwp.Helpers;
using System;
using System.Drawing;
using System.Drawing.Imaging;
using System.Runtime.InteropServices;
using System.Threading.Tasks;
using System.Windows.Forms;


namespace Mandelbrot_Namespace {
	
	class Mandebrot_class : Form {
		private readonly Bitmap MandelGrid = new(400, 400);
		private TextBox StartXInput;
		private TextBox StartYInput;
		private TextBox MaxTriesInput;
		private TextBox ScaleInput;
		private Label MandelDisplay;
		private Label StartXLabel;
		private Label StartYLabel;
		private Label ScaleLabel;
		private Label MaxTriesLabel;
		private CheckBox AutoUpdateCheckBox;
		private ComboBox SelectExampleList;
		private ComboBox SelectColorSchemeList;
		private Label MultiBrotlabel;
		private TextBox MultiBrotInput;
		private CheckBox MultiBrotCheckBox;
		private Label XCordLabel;
		private Label YCordLabel;
		private Button RecalculateButton;
		public Mandebrot_class() {
			Text = "Mandelbrot";
			InitializeComponent();
			// Leave here, otherwise the Visual Studio Designer interferes with it and removes it
			MandelDisplay.Image = MandelGrid;
			// Show the mandelbrot image when program opens
			RenderMandelImage();
		}
		// Don't change this function, is automaticly generated by the VS Designer
		// You can change the values of sizes, point etc
		private void InitializeComponent() {
			StartXInput = new TextBox();
			StartYInput = new TextBox();
			MaxTriesInput = new TextBox();
			ScaleInput = new TextBox();
			MandelDisplay = new Label();
			StartXLabel = new Label();
			StartYLabel = new Label();
			MaxTriesLabel = new Label();
			ScaleLabel = new Label();
			RecalculateButton = new Button();
			AutoUpdateCheckBox = new CheckBox();
			SelectExampleList = new ComboBox();
			SelectColorSchemeList = new ComboBox();
			MultiBrotlabel = new Label();
			MultiBrotInput = new TextBox();
			MultiBrotCheckBox = new CheckBox();
			XCordLabel = new Label();
			YCordLabel = new Label();
			SuspendLayout();
			// 
			// StartXInput
			// 
			StartXInput.Location = new Point(120, 10);
			StartXInput.Name = "StartXInput";
			StartXInput.Size = new Size(100, 27);
			StartXInput.TabIndex = 3;
			StartXInput.Text = "0";
			StartXInput.TextChanged += InputChanged;
			// 
			// StartYInput
			// 
			StartYInput.Location = new Point(120, 45);
			StartYInput.Name = "StartYInput";
			StartYInput.Size = new Size(100, 27);
			StartYInput.TabIndex = 4;
			StartYInput.Text = "0";
			StartYInput.TextChanged += InputChanged;
			// 
			// MaxTriesInput
			// 
			MaxTriesInput.Location = new Point(120, 77);
			MaxTriesInput.Name = "MaxTriesInput";
			MaxTriesInput.Size = new Size(100, 27);
			MaxTriesInput.TabIndex = 5;
			MaxTriesInput.Text = "100";
			MaxTriesInput.TextChanged += InputChanged;
			// 
			// ScaleInput
			// 
			ScaleInput.Location = new Point(299, 7);
			ScaleInput.Name = "ScaleInput";
			ScaleInput.Size = new Size(100, 27);
			ScaleInput.TabIndex = 4;
			ScaleInput.Text = "0.01";
			ScaleInput.TextChanged += InputChanged;
			// 
			// MandelDisplay
			// 
			MandelDisplay.Location = new Point(10, 195);
			MandelDisplay.Name = "MandelDisplay";
			MandelDisplay.Size = new Size(400, 400);
			MandelDisplay.TabIndex = 6;
			MandelDisplay.MouseClick += MandelDisplayMouseClick;
			MandelDisplay.MouseMove += MandelDisplayMouseMove;
			// 
			// StartXLabel
			// 
			StartXLabel.Location = new Point(10, 10);
			StartXLabel.Name = "StartXLabel";
			StartXLabel.Size = new Size(75, 27);
			StartXLabel.TabIndex = 2;
			StartXLabel.Text = "X Start: ";
			// 
			// StartYLabel
			// 
			StartYLabel.Location = new Point(10, 45);
			StartYLabel.Name = "StartYLabel";
			StartYLabel.Size = new Size(75, 27);
			StartYLabel.TabIndex = 1;
			StartYLabel.Text = "Y Start:";
			// 
			// MaxTriesLabel
			// 
			MaxTriesLabel.Location = new Point(10, 77);
			MaxTriesLabel.Name = "MaxTriesLabel";
			MaxTriesLabel.Size = new Size(75, 27);
			MaxTriesLabel.TabIndex = 0;
			MaxTriesLabel.Text = "Max Tries:";
			// 
			// ScaleLabel
			// 
			ScaleLabel.AutoSize = true;
			ScaleLabel.Location = new Point(237, 9);
			ScaleLabel.Name = "ScaleLabel";
			ScaleLabel.Size = new Size(51, 20);
			ScaleLabel.TabIndex = 8;
			ScaleLabel.Text = "Scale: ";
			// 
			// RecalculateButton
			// 
			RecalculateButton.Location = new Point(237, 72);
			RecalculateButton.Name = "RecalculateButton";
			RecalculateButton.Size = new Size(116, 32);
			RecalculateButton.TabIndex = 7;
			RecalculateButton.Text = "Go";
			RecalculateButton.UseVisualStyleBackColor = true;
			RecalculateButton.Click += RecalculateButtonClick;
			// 
			// AutoUpdateCheckBox
			// 
			AutoUpdateCheckBox.AutoSize = true;
			AutoUpdateCheckBox.Checked = true;
			AutoUpdateCheckBox.CheckState = CheckState.Checked;
			AutoUpdateCheckBox.Location = new Point(237, 44);
			AutoUpdateCheckBox.Name = "AutoUpdateCheckBox";
			AutoUpdateCheckBox.Size = new Size(116, 24);
			AutoUpdateCheckBox.TabIndex = 9;
			AutoUpdateCheckBox.Text = "Auto Refresh";
			AutoUpdateCheckBox.UseVisualStyleBackColor = true;
			// 
			// SelectExampleList
			// 
			SelectExampleList.FormattingEnabled = true;
			SelectExampleList.Items.AddRange(new object[] { "Default", "Heat", "Cyclone", "Snowflake", "Star", "Chinese vuur", "Rode zee", "Paarse zee", "Vuur stoot", "Sikkels", "Donker bos" });
			SelectExampleList.Location = new Point(12, 141);
			SelectExampleList.Name = "SelectExampleList";
			SelectExampleList.Size = new Size(145, 28);
			SelectExampleList.TabIndex = 11;
			SelectExampleList.Text = "Select Example";
			SelectExampleList.SelectedIndexChanged += SelectExampleListChanged;
			// 
			// SelectColorSchemeList
			// 
			SelectColorSchemeList.FormattingEnabled = true;
			SelectColorSchemeList.Items.AddRange(new object[] { "Black and White", "Red Green Blue", "Yellow Orange Red", "Hue Range" });
			SelectColorSchemeList.Location = new Point(237, 141);
			SelectColorSchemeList.Name = "SelectColorSchemeList";
			SelectColorSchemeList.Size = new Size(171, 28);
			SelectColorSchemeList.TabIndex = 12;
			SelectColorSchemeList.Text = "Select Color Scheme";
			SelectColorSchemeList.SelectedIndexChanged += SelectColorSchemeListChanged;
			// 
			// MultiBrotlabel
			// 
			MultiBrotlabel.AutoSize = true;
			MultiBrotlabel.Location = new Point(10, 113);
			MultiBrotlabel.Name = "MultiBrotlabel";
			MultiBrotlabel.Size = new Size(82, 20);
			MultiBrotlabel.TabIndex = 13;
			MultiBrotlabel.Text = "MuiltiBrot: ";
			// 
			// MultiBrotInput
			// 
			MultiBrotInput.Location = new Point(120, 110);
			MultiBrotInput.Name = "MultiBrotInput";
			MultiBrotInput.Size = new Size(100, 27);
			MultiBrotInput.TabIndex = 14;
			MultiBrotInput.Text = "3";
			MultiBrotInput.TextChanged += InputChangedMulti;
			// 
			// MultiBrotCheckBox
			// 
			MultiBrotCheckBox.AutoSize = true;
			MultiBrotCheckBox.Location = new Point(237, 112);
			MultiBrotCheckBox.Name = "MultiBrotCheckBox";
			MultiBrotCheckBox.Size = new Size(142, 24);
			MultiBrotCheckBox.TabIndex = 15;
			MultiBrotCheckBox.Text = "Enable MultiBrot";
			MultiBrotCheckBox.UseVisualStyleBackColor = true;
			MultiBrotCheckBox.CheckedChanged += InputChanged;
			// 
			// XCordLabel
			// 
			XCordLabel.AutoSize = true;
			XCordLabel.Location = new Point(17, 600);
			XCordLabel.Name = "XCordLabel";
			XCordLabel.Size = new Size(33, 20);
			XCordLabel.TabIndex = 16;
			XCordLabel.Text = "X: 0";
			// 
			// YCordLabel
			// 
			YCordLabel.AutoSize = true;
			YCordLabel.Location = new Point(265, 601);
			YCordLabel.Name = "YCordLabel";
			YCordLabel.Size = new Size(32, 20);
			YCordLabel.TabIndex = 17;
			YCordLabel.Text = "Y: 0";
			// 
			// Mandebrot_class
			// 
			ClientSize = new Size(420, 630);
			Controls.Add(YCordLabel);
			Controls.Add(XCordLabel);
			Controls.Add(MultiBrotCheckBox);
			Controls.Add(MultiBrotInput);
			Controls.Add(MultiBrotlabel);
			Controls.Add(SelectColorSchemeList);
			Controls.Add(SelectExampleList);
			Controls.Add(AutoUpdateCheckBox);
			Controls.Add(ScaleLabel);
			Controls.Add(RecalculateButton);
			Controls.Add(MaxTriesLabel);
			Controls.Add(StartYLabel);
			Controls.Add(StartXLabel);
			Controls.Add(StartXInput);
			Controls.Add(StartYInput);
			Controls.Add(ScaleInput);
			Controls.Add(MaxTriesInput);
			Controls.Add(MandelDisplay);
			Name = "Mandebrot_class";
			ResumeLayout(false);
			PerformLayout();
		}

		// The mandel image is being rendered here 
		private void RenderMandelImage() {
			// Get the scale input, otherwise return 
			if (!(double.TryParse(ScaleInput.Text.Replace('.', ','), out double Scale))) return;
			// Clear the image
			for (int i = 0; i < 400; i++) {
				for (int j = 0; j < 400; j++) {
					MandelGrid.SetPixel(i, j, Color.White);
				}
			}
			double MultiBrot = 2;
			// Get the other input variables
			if (!(double.TryParse(StartXInput.Text.Replace('.', ','), out double StartX))) StartX = 0;
			if (!(double.TryParse(StartYInput.Text.Replace('.', ','), out double StartY))) StartY = 0;
			if (!(int.TryParse(MaxTriesInput.Text.Replace('.', ','), out int MaxTries))) MaxTries = 100;
			if (MultiBrotCheckBox.Checked) {
				if (!(double.TryParse(MultiBrotInput.Text.Replace('.', ','), out MultiBrot))) MultiBrot = 3;
			}
			// Loop thru the 400x400 grid and adjust the cords with the input variables
			string ColorSchemeList = (SelectColorSchemeList.SelectedItem == null) ? "" : SelectColorSchemeList.SelectedItem.ToString();
			BitmapData data = MandelGrid.LockBits(new Rectangle(0, 0, 400, 400), ImageLockMode.WriteOnly, PixelFormat.Format32bppArgb);
			byte[] buffer = new byte[data.Stride * 400];
			ParallelLoopResult res = Parallel.For(0, 400, i => {
				for (int j = 0; j < 400; j++) {
					double MandelNumberX = (i - 200) * Scale + StartX;
					double MandelNumberY = (j - 200) * Scale + StartY;
					Color color;
					switch (ColorSchemeList) {
						case "Black and White":
							color = (CalcMandelNumber(MandelNumberX, MandelNumberY, MaxTries, MultiBrot) % 2 == 0) ? Color.Black : Color.White;
							break;
						case "Red Green Blue":
							double hue2 = (CalcMandelNumber(MandelNumberX, MandelNumberY, MaxTries, MultiBrot) % 128) / 128d;
							Windows.UI.Color c2 = ColorHelper.FromHsv(hue2 * 360, 1.0, 1.0, 1.0);
							color = Color.FromArgb(c2.A, c2.R, c2.G, c2.B);
							break;
						case "Yellow Orange Red":
							double hue1 = (CalcMandelNumber(MandelNumberX, MandelNumberY, MaxTries, MultiBrot) % 60) / 256d;
							Windows.UI.Color c1 = ColorHelper.FromHsv(hue1 * 360, 1.0, 1.0, 1.0);
							color = Color.FromArgb(c1.A, c1.R, c1.G, c1.B);
							break;
						case "Hue Range":
							double hue = (CalcMandelNumber(MandelNumberX, MandelNumberY, MaxTries, MultiBrot) % 256) / 256d;
							Windows.UI.Color c = ColorHelper.FromHsv(hue * 360, 1.0, 1.0, 1.0);
							color = Color.FromArgb(c.A, c.R, c.G, c.B);
							break;
						default:
							color = (CalcMandelNumber(MandelNumberX, MandelNumberY, MaxTries, MultiBrot) % 2 == 0) ? Color.Black : Color.White;
							break;
					}
					Buffer.BlockCopy(BitConverter.GetBytes(color.ToArgb()), 0, buffer, data.Stride * j + i * 4, 4);
					//MandelGrid.SetPixel(i, j, color);
				}
			});
			MandelGrid.UnlockBits(data);
			Marshal.Copy(buffer, 0, data.Scan0, buffer.Length);
			MandelDisplay.Invalidate();
		}
			
		// Returns the mandelnumber, don't change 
		private static int CalcMandelNumber(double x, double y, int MaxTries, double MultiBrot) {
			int Tries = 0; double a = 0, b = 0; 
			for (; Tries < MaxTries && (a * a + b * b) <= 4; ++Tries) {
				double ca = a, cb = b;
				for (int i = 1; i < MultiBrot; i++) {
					double temp = a * ca - b * cb;
					b = a * cb + b * ca;
					a = temp;
				}
				a += x;
				b += y;
			}
			return Tries;
		}
		private void RecalculateButtonClick(object sender, EventArgs e) {
			RenderMandelImage();
		}
		// Input fields change
		private void InputChanged(object sender, EventArgs e) {
			if (AutoUpdateCheckBox.Checked) RenderMandelImage();
		}

		private void InputChangedMulti(object sender, EventArgs e) {
			if (AutoUpdateCheckBox.Checked && MultiBrotCheckBox.Checked) RenderMandelImage();
		}

		// Mouseclicks, so zoom in and zoom out
		private void MandelDisplayMouseClick(object sender, MouseEventArgs e) {
			double ZoomFactor = (e.Button == MouseButtons.Left) ? 0.66 : 1.5;
			if (!(double.TryParse(StartXInput.Text.Replace('.', ','), out double StartX))) StartX = 0;
			if (!(double.TryParse(StartYInput.Text.Replace('.', ','), out double StartY))) StartY = 0;
			if (!(double.TryParse(ScaleInput.Text.Replace('.', ','), out double Scale))) return;
			StartXInput.Text = ((e.X - 200) * Scale + StartX).ToString();
			StartYInput.Text = ((e.Y - 200) * Scale + StartY).ToString();
			ScaleInput.Text = (Scale * ZoomFactor).ToString();
		}
		// Mouse move, show coords
		private void MandelDisplayMouseMove(object sender, MouseEventArgs e) {
			if (!(double.TryParse(StartXInput.Text.Replace('.', ','), out double StartX))) StartX = 0;
			if (!(double.TryParse(StartYInput.Text.Replace('.', ','), out double StartY))) StartY = 0;
			if (!(double.TryParse(ScaleInput.Text.Replace('.', ','), out double Scale))) return;
			double X = (e.X - 200) * Scale + StartX;
			double Y = (e.Y - 200) * Scale + StartY;
			XCordLabel.Text = $"X: {X}";
			YCordLabel.Text = $"Y: {Y}";
		}

		private void SelectExampleListChanged(object sender, EventArgs e) {
			switch (SelectExampleList.SelectedItem) {
				case "Default":
					StartXInput.Text = "0";
					StartYInput.Text = "0";
					ScaleInput.Text = "0.01";
					MaxTriesInput.Text = "100";
					SelectColorSchemeList.SelectedIndex = 0;
					MultiBrotCheckBox.Checked = false;
					break;
				case "Heat":
					StartXInput.Text = "-0.014";
					StartYInput.Text = "0.74";
					ScaleInput.Text = "3.1E-5";
					MaxTriesInput.Text = "400";
					SelectColorSchemeList.SelectedIndex = 3;
					MultiBrotCheckBox.Checked = false;
					break;
				case "Cyclone":
					StartXInput.Text = "-0.0127";
					StartYInput.Text = "0.737";
					ScaleInput.Text = "4.5E-5";
					MaxTriesInput.Text = "100";
					SelectColorSchemeList.SelectedIndex = 0;
					MultiBrotCheckBox.Checked = false;
					break;
				case "Snowflake":
					StartXInput.Text = "0.3598";
					StartYInput.Text = "-0.58693";
					ScaleInput.Text = "5E-6";
					MaxTriesInput.Text = "100";
					SelectColorSchemeList.SelectedIndex = 3;
					MultiBrotCheckBox.Checked = false;
					break;
				case "Star":
					StartXInput.Text = "-0.0419096";
					StartYInput.Text = "-0.98823553";
					ScaleInput.Text = "3.0803384674982227E-07";
					MaxTriesInput.Text = "600";
					SelectColorSchemeList.SelectedIndex = 1;
					MultiBrotCheckBox.Checked = false;
					break;
				case "Chinese vuur":
					StartXInput.Text = "-0.0127";
					StartYInput.Text = "0.737";
					ScaleInput.Text = "4.5E-5";
					MaxTriesInput.Text = "100";
					SelectColorSchemeList.SelectedIndex = 3;
					MultiBrotCheckBox.Checked = false;
					break;
				case "Rode zee":
					StartXInput.Text = "-0.0127";
					StartYInput.Text = "0.737";
					ScaleInput.Text = "4.5E-6";
					MaxTriesInput.Text = "999";
					SelectColorSchemeList.SelectedIndex = 2;
					MultiBrotCheckBox.Checked = false;
					break;
				case "Paarse zee":
					StartXInput.Text = "-0.0127";
					StartYInput.Text = "0.737";
					ScaleInput.Text = "4.5E-6";
					MaxTriesInput.Text = "100";
					SelectColorSchemeList.SelectedIndex = 1;
					MultiBrotCheckBox.Checked = false;
					break;
				case "Vuur stoot":
					StartXInput.Text = "-0.0127";
					StartYInput.Text = "0.737";
					ScaleInput.Text = "4.5E-5";
					MaxTriesInput.Text = "250";
					SelectColorSchemeList.SelectedIndex = 3;
					MultiBrotCheckBox.Checked = false;
					break;
				case "Sikkels":
					StartXInput.Text = "0.3598";
					StartYInput.Text = "-0.58693";
					ScaleInput.Text = "5E-6";
					MaxTriesInput.Text = "100";
					SelectColorSchemeList.SelectedIndex = 2;
					MultiBrotCheckBox.Checked = false;
					break;
				case "Donker bos":
					StartXInput.Text = "-0.0127";
					StartYInput.Text = "0.737";
					ScaleInput.Text = "4.5E-6";
					MaxTriesInput.Text = "100";
					SelectColorSchemeList.SelectedIndex = 0;
					MultiBrotCheckBox.Checked = false;
					break;
			}
			if (AutoUpdateCheckBox.Checked) RenderMandelImage();
		}
		private void SelectColorSchemeListChanged(object sender, EventArgs e) {
			if (AutoUpdateCheckBox.Checked) RenderMandelImage();
		}
	}
}